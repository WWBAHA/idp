##  模块设计

### IDP运行态模块

  1. 单点登录模块  
    用于获取从SP转发来的请求和将请求转发给SP

  2. 用户身份认证模块  
    通过帐号密码，证书或者OTT来认证用户身份
  
  3. 用户属性查询模块
    向数据库查询用户所拥有的属性

  4. 断言服务模块  
    提供解析和封装断言的功能

  5. 数据库连接模块  
    负责与LDAP数据库进行通讯

### 管理员模块

  1. 超级管理员模块  
    管理所有的租户

  2. 租户管理员模块  
    负责管理本租户内的所有数据

  3. 用户管理模块  
    管理用户本身的数据

##  接口设计

###  外部接口

与用户界面交互的接口

####  面向超级管理员的接口

  1. 超级管理员登录，注销，修改信息。  
  2. 添加，删除，修改租户
  3. 查看租户列表和详细信息

####  面向租户管理员的接口

  1. 租户管理员登录，注销，修改自身信息
  2. 用户管理  
    添加，删除，修改用户。
  3. SAML断言服务管理  
    选择IDP向SP发送的断言。
  4. 群组管理  
    添加，删除修改群组
  5. 给用户分配群组  

####  面向用户的接口

  1. 用户登录，注销
  2. 用户自身属性修改
  3. 用户注册

####  面向SP的接口

  1. 接受SAML请求
  2. 用户身份验证
  3. 重定向SAML响应

###  内部接口

  1. 单点登录和断言服务的接口  
    单点登录接受到断言请求后移交给断言服务进行解析。当单点登录服务需要返回数据时调用断言服务输出断言响应。
  2. 单点登录和用户身份验证之间的接口
    当单点登录服务需要验证用户身份时，调用用户身份验证模块对用户进行身份验证。
  3. 身份验证模块和用户属性查询模块之间的接口  
    身份验证模块获取用户验证信息后，将表示用户身份的信息传递给用户属性查询模块，用户属性查询模块决定用户数据是否匹配。
  4. 单点登录和用户属性查询模块之间的接口  
    单点登录需要查询用户属性时，将用户信息传递给用户查询模块进行查询。
  5. 用户属性查询模块和数据库模块的接口
    用户属性模块将查询传递给数据库模块，由数据库模块和数据库通讯，执行真正的查询。

![内部接口图](http://ww4.sinaimg.cn/large/a74e55b4jw1e3sy52v3wgj21kw0p2wfy.jpg,"内部接口图")

###  单点登录模块

#### 功能  
  单点登录模块主要是接收SP传递过来的认证请求，调用认证模块进行用户身份验证，然后将认证的结果传递给SP  

#### 工作流程  
  ![单点登录流程图](http://ww3.sinaimg.cn/large/a74e55b4jw1e3tw93m2lgj21kw058dgr.jpg , "单点登录流程图")

  1. 获取SP传递过来的SAML请求
  2. 调用断言服务模块解析SAML请求
  3. 调用身份验证模块验证用户身份
  4. 调用用户属性查询模块查询用户属性
  5. 调用断言服务模块生成断言响应
  6. 将生成的断言响应传递给SP

  **注意：**以上任意一个步骤出错后程序即可终止，终止时可以向SP返回错误信息或者无需返回信息。
#### 外部接口  

### 用户身份认证模块  

#### 功能  
  用户身份认证模块主要实现用户的身份认证功能，支持口令认证、证书认证等多种传统认证方式，使用方式灵活，通用性强。它主要包括通用认证模块、口令认证模块、证书认证模块等。

#### 工作流程   
  ![用户身份认证模块流程图](http://ww2.sinaimg.cn/large/a74ecc4cjw1e3txkbr95cj21kw06qq3v.jpg , "用户身份认证模块流程图")

  1. 获取认证请求
  2. 向用户请求身份凭证
  3. 获取身份凭证
  4. 调用具体认证模块验证身份凭证
  5. 返回验证结果

#### 接口
  1. 与单点登录服务接口

### 用户属性查询模块

#### 功能  
  属性查询模块主要是提供给单点登录模块和管理模块查询用户属性的功能，可以根据用户的唯一特征(如用户名，邮箱等)查询用户的其他属性
  
#### 工作流程  
  ![用户属性查询模块流程图](http://ww2.sinaimg.cn/large/a74eed94jw1e3ty2nyy1aj21kw0exgmt.jpg,"用户属性查询模块流程图")

  1. 获取查询请求
  2. 获取用户身份特征
  3. 调用数据库模块查询用户
  4. 返回查询结果  
    * 如果用户存在，返回用户属性
    * 如果用户不存在，返回一个错误码。

#### 外部接口  
  1. 与单点登录的接口
  2. 与管理相关的接口

### 数据库连接模块

#### 功能  
  数据库查询模块是对LDAP数据库功能的一种封装，提供查询，更新，添加等数据库操作功能。

#### 工作流程
  ![数据库连接模块流程图](http://ww3.sinaimg.cn/large/a74e55b4jw1e3tyuy48d1j21kw06qaaw.jpg,"数据库连接模块流程图")

  1. 接受操作请求
  2. 接受操作命令和参数
  3. 连接数据库
  4. 操作数据库
  5. 返回操作结果

#### 外部接口
  1. 与用户属性查询模块的接口
  2. 与用户身份验证模块的接口

###  超级管理员模块设计

###  租户管理员设计

###  用户管理员设计